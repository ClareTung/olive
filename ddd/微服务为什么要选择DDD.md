## 领域驱动设计：微服务为什么要选择DDD

* DDD是一种架构设计方法，微服务是一种架构风格。二者都是为了追求响应能力，而从业务视角去分离应用系统建设复杂度的手段。

### 软件架构模式的演进

* 单机架构
  * 采用面向过程的设计方法，包括客户端UI和数据库两层，采用C/S架构模式
* 集中式架构
  * 采用面向对象的设计方法，包括业务接入层、业务逻辑层和数据库层，采用经典的三层架构
* 分布式微服务架构
  * 微服务架构可以很好地实现应用之间的解耦，解决单体应用扩展性和伸缩能力不足的问题
* 在单机和集中式架构这两种模式下，软件无法快速响应需求和业务的迅速变化。

### 微服务设计和拆分的困境

* 微服务拆分困难的根本原因，就是不知道业务或者微服务的边界到底在哪里？
* 利用DDD设计方法来建立领域模型，划分领域边界，再根据这些领域边界从业务视角来划分微服务边界。

### 为什么DDD适合微服务

* DDD包括战略设计和战术设计两部分。
* **战略设计**主要从业务视角出发，建立业务领域模型，划分领域边界，建立通用语言的限界上下文，限界上下文可以作为微服务设计的参考边界。
* **战术设计**从技术视角出发，侧重于领域模型的技术实现，完成软件开发和落地，包括：聚合根、实体、值对象、领域服务、应用服务和资源库等代码逻辑的设计和实现。
* DDD战略设计会建立领域模型，**领域模型**可以用于指导微服务的设计和拆分。
* **事件风暴**是建立领域模型的主要方法，它是一个从发散到收敛的过程。它通常采用用例分析、场景分析和用户旅程分析，尽可能全面不遗漏地分解业务领域，并梳理领域对象之间的关系，这是一个发散的过程。事件风暴过程中会产生很多的实体、命令、事件等领域对象，我们将这些领域对象从不同的维度进行聚类，形成如聚合、限界上下文等边界，建立领域模型，这就是一个收敛的过程。

![image-20211021130515705](https://cdn.jsdelivr.net/gh/ClareTung/ImageHostingService/img/image-20211021130515705.png)

**我们可以用三步来划定领域模型和微服务的边界。**

* 第一步：在事件风暴中梳理业务过程中的用户操作、事件以及外部依赖关系等，根据这些要素梳理出领域实体等领域对象。
* 第二步：根据领域实体之间的业务关联性，将业务紧密相关的实体进行组合形成聚合，同时确定聚合中的聚合根、值对象和实体。在这个图里，聚合之间的边界是第一层边界，它们在同一个微服务实例中运行，这个边界是逻辑边界，所以用虚像表示。
* 第三步：根据业务及语义边界等因素，将一个或者多个聚合划定在一个限界上下文内，形成领域模型。在这个图里，限界上下文之间的边界是第二层边界，这一层边界可能就是未来微服务的边界，不同限界上下文内的领域逻辑被隔离在不同的微服务实例中运行，物理上相互隔离，所以是物理边界，边界之间用实线来表示。

在从业务模型向微服务落地的过程中，也就是从战略设计向战术设计的实施过程中，我们会将领域模型中的领域对象与代码模型中的代码对象建立映射关系，将业务架构和系统架构进行绑定。当我们去响应业务变化调整业务架构和领域模型时，系统架构也会同时发生调整，并同步建立新的映射关系。

### DDD和微服务的关系

* DDD主要关注：从业务领域视角划分领域边界，构建通用语言进行高效沟通，通过业务抽象，建立领域模型，维持业务和代码的逻辑一致性。
* 微服务主要关注：运行时的进程间通信、容错和故障隔离，实现去中心化数据管理和去中心化服务治理，关注微服务的独立开发、测试、构建和部署。

### DDD可以给你带来以下收获

* DDD是一套完整而系统的设计方法，它能带给你从战略设计到战术设计的标准设计过程，使得你的设计思路能够更加清晰，设计过程更加规范。
* DDD善于处理与领域相关的拥有高复杂度业务的产品开发，通过它可以建立一个核心而稳定的领域模型，有利于领域知识的传递与传承。
* DDD强调团队与领域专家的合作，能够帮助你的团队建立一个沟通良好的氛围，构建一致的架构体系。
* DDD的设计思想、原则与模式有助于提高你的架构设计能力。
* 无论是在新项目中设计微服务，还是将系统从单体架构演进到微服务，都可以遵循DDD的架构原则。
* DDD不仅适用于微服务，也适用于传统的单体应用。