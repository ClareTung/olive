## Redis-延时队列

### 异步消息队列

* Redis的list（列表）数据结构常用来作为消息队列使用，使用`rpush/lpush`操作入队列，使用`lpop/rpop`来出队列

![image-20210828133851056](https://cdn.jsdelivr.net/gh/ClareTung/ImageHostingService/img/image-20210828133851056.png)

```
hp笔记本:0>rpush q apple banana pear
"3"

hp笔记本:0>llen q
"3"

hp笔记本:0>lpop q
"apple"

hp笔记本:0>lpop q
"banana"

hp笔记本:0>lpop q
"pear"

hp笔记本:0>lpop q
null
```

### 队列空了怎么办？

* 客户端通过队列的pop操作来获取消息，然后进行处理。队列空了，客户端就会陷入pop空循环，会造成客户端cpu高，redis的qps也高。
* 解决方法：让线程睡一会。（1s）

### 队列延迟

* 睡眠可以解决队列空的问题，但是会导致消息延迟。
* 使用`blopo/brpop`阻塞读，阻塞读在队列没有数据的时候，会立即进入休眠状态，一旦数据到来，则立即醒过来。消息的延迟几乎为零。

### 空闲链接自动断开

* 线程一直阻塞，Redis客户端的链接就成了空闲连接，空闲过久，服务器就会主动断开连接，减少空闲资源占用。此时，`blpop/brpop`就会抛出异常。
* 客户消费者需要注意捕获异常，还要重试。

### 锁冲突处理

1. 直接抛出异常，通知用户稍后重试
2. sleep一会再重试
3. 将请求转移至延时队列，过一会再试

### 延时队列的实现

* 通过zset（有序列表）来实现
* 将消息序列化成一个字符串作为zset的value，这个消息的到期时间作为score，采用多个线程轮询zset获取到期的任务进行处理。
* 多个线程需要考虑并发争抢任务，确保任务不能被多次执行。
* Redis 的 zrem 方法是多线程多进程争抢任务的关键，它的返回值决定了当前实例有没有抢到任务， 因为 loop 方法可能会被多个线程、多个进程调用，同一个任务可能会被多个进程线程抢到，通过 zrem  来决定唯一的属主。





