## Redis-Sentinel（哨兵）

![image-20210902131832930](https://cdn.jsdelivr.net/gh/ClareTung/ImageHostingService/img/image-20210902131832930.png)

* Redis Sentinel 集群看成是一个 ZooKeeper 集群，它是集群高可用的心脏， 它一般是由 3～5 个节点组成，这样挂了个别节点集群还可以正常运转。
* 它负责持续监控主从节点的健康，当主节点挂掉时，自动选择一个最优的从节点切换为 主节点。客户端来连接集群时，会首先连接 sentinel，通过 sentinel 来查询主节点的地址， 然后再去连接主节点进行数据交互。当主节点发生故障时，客户端会重新向 sentinel 要地 址，sentinel 会将最新的主节点地址告诉客户端。如此应用程序将无需重启即可自动完成节 点切换。

![image-20210902132945546](https://cdn.jsdelivr.net/gh/ClareTung/ImageHostingService/img/image-20210902132945546.png)

* 从这张图中我们能看到主节点挂掉了，原先的主从复制也断开了，客户端和损坏的主节 点也断开了。从节点被提升为新的主节点，其它从节点开始和新的主节点建立复制关系。客 户端通过新的主节点继续进行交互。Sentinel 会持续监控已经挂掉了主节点，待它恢复后， 集群会调整为下面这张图。

![image-20210902133029180](https://cdn.jsdelivr.net/gh/ClareTung/ImageHostingService/img/image-20210902133029180.png)

* 此时原先挂掉的主节点现在变成了从节点，从新的主节点那里建立复制关系。

### 消息丢失

* Redis 主从采用异步复制，意味着当主节点挂掉时，从节点可能没有收到全部的同步消 息，这部分未同步的消息就丢失了。如果主从延迟特别大，那么丢失的数据就可能会特别 多。Sentinel 无法保证消息完全不丢失，但是也尽可能保证消息少丢失。它有两个选项可以 限制主从延迟过大。
*  min-slaves-to-write 1 
* min-slaves-max-lag 10
*  第一个参数表示主节点必须至少有一个从节点在进行正常复制，否则就停止对外写服 务，丧失可用性。 
* 何为正常复制，何为异常复制？这个就是由第二个参数控制的，它的单位是秒，表示如 果 10s 没有收到从节点的反馈，就意味着从节点同步不正常，要么网络断开了，要么一直没 有给反馈。